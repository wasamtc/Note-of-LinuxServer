# 第一章：TCP/IP协议族

## 一.TCP/IP协议族体系结构以及主要协议

首先来看整个体系结构：

![img](https://img-blog.csdnimg.cn/20200921180905846.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JvY2tldGNwMw==,size_16,color_FFFFFF,t_70)

每一层利用下一层提供的服务实现不同的功能，同时为上一层提供服务。

### 1.数据链路层

数据链路层的主要实现网卡接口的网络驱动程序，这个驱动程序隐藏了处理数据在物理媒介上的传输。

主要有两个协议ARP（地址解析协议）和RARP（逆地址解析协议），ARP负责把IP地址转换为物理地址（一般为mac）地址，网络层使用IP地址寻找一台主机，而数据链路层使物理地址寻找一台主机，因此网络层要使用数据链路层的功能必须使用ARP完成转换。有的工作站没有存储设备无法记住自己的IP地址，所以用RARP向管理者用物理地址查询自己的IP地址。

### 2.网络层

网络层最重要的功能是路由与转发，其中IP协议决定逐跳，这些在计算机网络中都有详细的介绍。

除了IP协议，还有ICMP协议，这个协议主要用来检测网络连接。报文格式如下：

![img](https://img-blog.csdnimg.cn/20210924113832936.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5Z6D5Zy-6KKL5oy66IO96JeP5ZWK,size_16,color_FFFFFF,t_70,g_se,x_16)

8位类型把报文分为两类，一种是差错报文，用来回应网络错误，例如不可达和重定向。另一种是查询报文，例如ping。

8位代码字段还可以进一步区分，例如重定向中主机重定向和网络重定向。ICMP使用了IP协议的服务。

### 3.传输层

TCP是基于字节流的，可以按字节发送和收取，而UDP是基于数据报的，只能按数据报发送和收取。

其余知识计算机网络中有详细的介绍。

### 4.应用层

一般来说，其他层次都是在内核中实现的，而应用层是在用户空间实现的。应用层也有很多协议和程序：

ping：检测网络连接，直接使用网络层的icmp

telnet：远程登录协议，可以在本地完成远程任务

OSPF：动态路由更新协议，用于路由器之间获取各自的路由信息

DNS：域名与IP地址间的转换

## 二.封装

上层协议是如何使用下层协议的服务的，通过封装，即沿着协议栈从上往下依次传递，在传递的过程中在上层数据的基础上加上自己的头部（和尾部）。

TCP从应用层的缓冲区复制数据到内核发送缓冲区，然后加上头部给网络层，UDP类似，不过不需在内核层中保留信息。

IP和数据链路层也加上相应的头部信息。

## 三.分用

分用就是自底向上分解帧以把数据传到应用层，每一层都有报文区分要把数据报发给上一层的哪个协议或程序。

## 四.测试网络

以后的讨论和测试可能使用下面的测试网络：

![image-20220417142739808](C:\Users\q1369\AppData\Roaming\Typora\typora-user-images\image-20220417142739808.png)

## 五.ARP协议工作原理

ARP协议实现任意网络层地址到任意物理地址的转换，本书讨论的是IP地址到mac地址的转换，其中原理是主机向所在网络广播一个ARP请求，请求中包含目标IP地址，当目标收到后发送一个ARP应答，应答中包含主机的物理地址。

ARP有一个高速缓存可以缓存最近的映射。

## 六.DNS工作原理

DNS将域名转换为IP地址，具体原理见书。

## 七.socket和TCP/IP协议族的关系

应用层在用户空间，而其他层次在内核空间，所以需要一组系统调用来连通双方，而socket就是起这样的作用。