# TCP协议详解

TCP相对UDP的特点是面向连接，字节流，可靠传输。

## 一.TCP头部结构

在计网中学过TCP头部结构，不过这里面还是有好些没学过的东西，特别是关于选项中具体的知识，例如SACK。

## 二.TCP连接的建立和关闭

TCP通过三次握手建立连接，通过四次挥手关闭连接，发送了FIN，但还没有收到对方的FIN，此时主机处于半关闭状态，只能发送确认和接收数据，不能发送数据。使用半关闭的应用程序很少。

如果连接超时将尝试重连，超时时间是从1s翻倍递增的，如果重连超过规定次数仍失败则停止重连并通知应用程序。

## 三.TCP状态转移

TCP的客户端和服务端都可以看做自动机，在不同的状态之间转移，特别注意三次握手四次挥手的过程，当客户端发送FIN后，又收到服务端的ACK和FIN，那么客户端就进入了TIME_WAIT状态，此时客户端的TCP连接还没有关闭，占用的端口号不能给别的进程用（一个进程可以bind多个端口号，但一个端口号只能给一个进程用，除非是父子进程），TIME_WAIT状态是为了防止客户端发的ACK丢失以及丢弃掉所有网络中仍在传输的属于此连接的数据。一般持续时间为两个报文段最大生存时间。

## 四.复位报文段

复位报文段可用来通知对方关闭连接或重新建立连接，有三种情况发送复位报文段。

第一种是访问不存在的端口，服务端发送复位报文，或连接处于TIME_WAIT状态的连接的端口。

第二种是异常终止连接，即可以给对方发送一个复位报文段来异常终止这个连接，发送端所有排队等待发送的数据都将被丢弃。

第三种是一种叫半打开的状态。例如客户端和服务端建立了连接，服务端这时断电了，然后重启，但是服务端的连接已经不存在了，客户端的连接此时就处于半打开状态，此时客户端向服务端发送数据，服务端就回应复位报文段。

## 五.TCP数据流

TCP连接中报文段所携带的数据按照长度分为两种：交互数据和成块数据，交互数据包含很少的字节，实时性要求高，成块数据包含最大数据长度，传输效率要求高。

## 六.TCP带外数据

有一说一，这个带外数据我是真没理解为什么要把指针指向下一个，指向下一个还怎么找呢，带外数据是紧急要发送的数据，TCP，UDP都没有实现带外数据，但是TCP可以用紧急数据来代替带外数据，带外数据只能有一字节，放在接收方专门的带外缓存中，可能被后续的紧急数据覆盖。

## 七.超时重传

如果发送方发送数据后在一定时间内没有收到ACK就会引发重传事件，超时时间两倍增长，一般由放弃连接前次数限制和底层IP接管前次数限制。
